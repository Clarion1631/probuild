generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String      @id @default(cuid())
  email      String      @unique
  name       String?
  role       String      @default("EMPLOYEE") // ADMIN, MANAGER, EMPLOYEE
  hourlyRate Float       @default(0)
  burdenRate Float       @default(0)
  pinCode    String?     // Used for mobile app quick login
  timeEntries TimeEntry[]
  assignedProjects Project[] @relation("CrewAssignments")
}

model Client {
  id              String   @id @default(cuid())
  name            String
  initials        String
  email           String?
  companyName     String?
  primaryPhone    String?
  additionalEmail String?
  additionalPhone String?
  
  addressLine1    String?
  addressLine2    String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  
  internalNotes   String?
  
  projects        Project[]
  leads           Lead[]
  invoices        Invoice[]
}

model Lead {
  id                String    @id @default(cuid())
  name              String
  clientId          String
  client            Client    @relation(fields: [clientId], references: [id])
  stage             String    @default("New") // New, Followed Up, Connected, Estimate Sent, Won, Closed
  source            String?   // My website, Houzz, Manually created lead
  projectType       String?
  location          String?
  targetRevenue     Float?
  expectedStartDate DateTime?
  createdAt         DateTime  @default(now())
  estimates         Estimate[]
  floorPlans        FloorPlan[]
  contracts         Contract[]
}

model Project {
  id        String    @id @default(cuid())
  name      String
  clientId  String
  client    Client    @relation(fields: [clientId], references: [id])
  viewedAt  DateTime  @default(now())
  createdAt DateTime  @default(now())
  location  String?
  status    String    @default("In Progress") // In Progress, Closed, Paid Ready to Start
  type      String?   // Kitchen Remodeling, Patio, Water Damage
  code      String?
  tags      String?
  managerId String?
  estimates Estimate[]
  invoices    Invoice[]
  budgets     Budget[]
  timeEntries TimeEntry[]
  floorPlans  FloorPlan[]
  contracts   Contract[]
  crew        User[]      @relation("CrewAssignments")
}

model FloorPlan {
  id          String   @id @default(cuid())
  name        String
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  leadId      String?
  lead        Lead?    @relation(fields: [leadId], references: [id])
  modelUrl    String?  // URL to raw GLTF/GLB model from iPhone scan
  data        String?  // JSON stringified layout data for 2D/3D walls & furniture
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Estimate {
  id          String   @id @default(cuid())
  title       String
  
  // Flexible Relation: Can belong to a Project OR a Lead
  projectId   String?
  project     Project?   @relation(fields: [projectId], references: [id])
  leadId      String?
  lead        Lead?     @relation(fields: [leadId], references: [id])

  code        String
  status      String   @default("Sent") // Invoiced, Partially Paid, Sent, Approved
  privacy     String   @default("Shared") // Shared, Private
  createdAt   DateTime @default(now())
  totalAmount Float
  balanceDue  Float
  items       EstimateItem[]
  expenses    Expense[]
  paymentSchedules EstimatePaymentSchedule[]
  budget      Budget?

  // Phase 7: Contracts & Approvals
  approvedBy  String?
  approvedAt  DateTime?
  approvalIp  String?
  approvalUserAgent String?
  signatureUrl String?
  contractId  String?
  contract    Contract?  @relation(fields: [contractId], references: [id])
  
  // Phase 8: Tracking
  viewedAt    DateTime?
}

model EstimatePaymentSchedule {
  id          String   @id @default(cuid())
  estimateId  String
  estimate    Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  name        String
  percentage  Float?   // Optional: represent this payment as a % of the total
  amount      Float
  dueDate     DateTime?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
}

model EstimateItem {
  id          String   @id @default(cuid())
  estimateId  String
  estimate    Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  name        String
  description String?
  type        String   @default("Material") // Material, Labor, Subcontractor
  quantity    Float    @default(1)
  unitCost    Float    @default(0)
  total       Float    @default(0)
  order       Int      @default(0)
  parentId    String?
  parent      EstimateItem?   @relation("SubItems", fields: [parentId], references: [id], onDelete: Cascade)
  subItems    EstimateItem[]  @relation("SubItems")
  expenses    Expense[]
  createdAt   DateTime @default(now())
}

model Expense {
  id          String   @id @default(cuid())
  estimateId  String
  estimate    Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  itemId      String?
  item        EstimateItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)
  amount      Float
  vendor      String?
  date        DateTime?
  description String?
  receiptUrl  String?
  status      String   @default("Pending") // Pending, Reviewed
  createdAt   DateTime @default(now())
}

model Invoice {
  id          String   @id @default(cuid())
  code        String
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  status      String   @default("Draft") // Draft, Issued, Paid, Overdue
  totalAmount Float    @default(0)
  balanceDue  Float    @default(0)
  issueDate   DateTime?
  createdAt   DateTime @default(now())
  
  payments    PaymentSchedule[]
}

model PaymentSchedule {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  name        String
  amount      Float
  status      String   @default("Pending") // Pending, Paid, Canceled
  dueDate     DateTime?
  paymentDate DateTime?
  createdAt   DateTime @default(now())
}

model Budget {
  id                  String   @id @default(cuid())
  projectId           String
  project             Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  estimateId          String   @unique
  estimate            Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  totalLaborBudget    Float    @default(0)
  totalMaterialBudget Float    @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  buckets             BudgetBucket[]
}

model BudgetBucket {
  id             String   @id @default(cuid())
  budgetId       String
  budget         Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  name           String
  laborBudget    Float    @default(0)
  materialBudget Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  timeEntries    TimeEntry[]
}

model TimeEntry {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId        String
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  budgetBucketId   String?
  budgetBucket     BudgetBucket? @relation(fields: [budgetBucketId], references: [id], onDelete: Cascade)
  
  startTime        DateTime
  endTime          DateTime?
  durationHours    Float?
  
  latitude         Float?
  longitude        Float?
  
  laborCost        Float?
  burdenCost       Float?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Audit history
  editedByManagerId String?
  editedAt          DateTime?
}

model Contract {
  id          String   @id @default(cuid())
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  leadId      String?
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  title       String
  body        String   // HTML string of the legal agreement
  status      String   @default("Draft") // Draft, Sent, Signed
  
  estimates   Estimate[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CompanySettings {
  id                String   @id @default("singleton")
  companyName       String   @default("My Construction Co.")
  address           String?
  phone             String?
  email             String?
  website           String?
  logoUrl           String?
  notificationEmail String?  // Where to send View/Sign alerts
  
  updatedAt         DateTime @updatedAt
}
